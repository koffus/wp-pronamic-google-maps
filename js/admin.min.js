!function(a){var b=function(b){var c=this,d=a(b),e=null,f=null,g={};g.description=d.find("#pgm-description-field"),g.address=d.find("#pgm-address-field"),g.latitude=d.find("#pgm-lat-field"),g.longitude=d.find("#pgm-lng-field"),g.mapType=d.find("#pgm-map-type-field"),g.zoom=d.find("#pgm-zoom-field");var h=d.find("#pgm-canvas").get(0);if(h){var i=new google.maps.LatLng(g.latitude.val(),g.longitude.val()),j=parseInt(g.zoom.val(),10);isNaN(j)&&(j=0);var k=g.mapType.val();""===k&&(k=google.maps.MapTypeId.ROADMAP);var l={zoom:j,center:i,mapTypeId:k};e=new google.maps.Map(h,l);var m=new google.maps.Geocoder;f=new google.maps.Marker({position:i,map:e,draggable:!0});var n=new google.maps.InfoWindow({content:g.description.val()});n.open(e,f),d.find("#pgm-geocode-button").click(function(){return c.geocode(),!1}),d.find("#pgm-reverse-geocode-button").click(function(){return c.reverseGeocode(),!1})}this.updateMarker=function(){var a=new google.maps.LatLng(g.latitude.val(),g.longitude.val());f.setPosition(a),e.setCenter(a)},this.updateFields=function(){var a=f.getPosition();g.latitude.val(a.lat()),g.longitude.val(a.lng()),g.zoom.val(e.getZoom()),g.mapType.val(e.getMapTypeId())},this.geocode=function(){var a=g.address.val(),b=a.replace(/(\r\n|[\r\n])/g,", ");m.geocode({address:b},function(a,b){if(google.maps.GeocoderStatus.OK===b&&a[0]){var c=a[0].geometry.location,d=a[0].geometry.viewport;g.latitude.val(c.lat()),g.longitude.val(c.lng()),f.setPosition(c),e.setCenter(c),e.fitBounds(d)}})},this.reverseGeocode=function(){var a=new google.maps.LatLng(g.latitude.val(),g.longitude.val());m.geocode({latLng:a},function(a,b){if(google.maps.GeocoderStatus.OK===b&&a[0]){var c=a[0].formatted_address;g.address.val(c)}})},google.maps.event.addListener(e,"maptypeid_changed",c.updateFields),google.maps.event.addListener(e,"zoom_changed",c.updateFields),google.maps.event.addListener(f,"drag",c.updateFields),google.maps.event.addListener(f,"dragend",c.updateFields),g.latitude.keyup(c.updateMarker),g.latitude.change(c.updateMarker),g.longitude.keyup(c.updateMarker),g.longitude.change(c.updateMarker),g.description.keyup(function(){n.setContent(g.description.val())}),g.description.change(function(){n.setContent(g.description.val())})},c=function(b){var c=a(b),d={};d.latitude=c.find(".latitude-field"),d.longitude=c.find(".longitude-field"),d.description=c.find(".description-field"),d.mapType=c.find(".map-type-field"),d.zoom=c.find(".zoom-field");var e=b.find(".google-maps-canvas"),f=new google.maps.LatLng(d.latitude.val(),d.longitude.val()),g=parseInt(d.zoom.val(),10);isNaN(g)&&(g=0);var h=d.mapType.val();""===h&&(h=google.maps.MapTypeId.ROADMAP);var i={zoom:g,center:f,mapTypeId:h},j=new google.maps.Map(e.get(0),i),k=new google.maps.Marker({position:f,map:j,draggable:!0}),l=new google.maps.InfoWindow({content:d.description.val()});l.open(j,k);var m=function(){var a=new google.maps.LatLng(d.latitude.val(),d.longitude.val());k.setPosition(a),j.setCenter(a)},n=function(){var a=k.getPosition();d.latitude.val(a.lat()),d.longitude.val(a.lng()),d.zoom.val(j.getZoom()),d.mapType.val(j.getMapTypeId())};google.maps.event.addListener(j,"maptypeid_changed",n),google.maps.event.addListener(j,"zoom_changed",n),google.maps.event.addListener(k,"drag",n),google.maps.event.addListener(k,"dragend",n),d.latitude.keyup(m).change(m),d.longitude.keyup(m).change(m),d.description.change(function(){l.setContent(d.description.val())}),d.description.keyup(function(){l.setContent(d.description.val())});var o=function(){google.maps.event.trigger(j,"resize"),j.setCenter(f)};b.closest(".widget").find(".widget-action").click(function(){setTimeout(o,1e3)})},d=function(b){var c=this,d=a(b),e={};e.ID=d.find("#pgm-id-field"),e.title=d.find("#pgm-title-field"),e.address=d.find("#pgm-address-field"),e.latitude=d.find("#pgm-lat-field"),e.longitude=d.find("#pgm-lng-field"),e.mapType=d.find("#pgm-map-type-field"),e.zoom=d.find("#pgm-zoom-field"),e.foundPosts=d.find("#pgm-found-posts"),e.status=d.find("#pgm-status-field");var f=new google.maps.Geocoder;b.find("#submit").click(function(){return c.startGeocode(),!1}),this.startGeocode=function(){var d=e.address.val(),g=d.replace(/(\r\n|[\r\n])/g,", ");f.geocode({address:g},function(d,f){if(e.status.val(f),google.maps.GeocoderStatus.OK===f&&d[0]){{var g=d[0].geometry.location;d[0].geometry.viewport}e.latitude.val(g.lat()),e.longitude.val(g.lng())}a.post(ajaxurl,b.serialize(),function(a){c.updateFields(a)})})},this.updateFields=function(a){if(e.foundPosts.text(a.foundPosts),a.nextPost){var d=a.nextPost;e.ID.val(d.ID),e.title.val(d.title),e.address.val(d.address),e.latitude.val(d.latitude),e.longitude.val(d.longitude),c.startGeocode()}else b.hide()}};a.fn.pronamicGoogleMapsMetaBox=function(c){return this.each(function(){var d=a(this);if(!d.data("pgm-meta-box")){var e=new b(this,c);d.data("pgm-meta-box",e)}})},a.fn.pronamicGoogleMapsWidget=function(b){return this.each(function(){var d=a(this);if(!d.data("pgm-widget")){var e=new c(this,b);d.data("pgm-widget",e)}})},a.fn.pronamicGoogleMapsGeocoder=function(b){return this.each(function(){var c=a(this);if(!c.data("pgm-geocoder")){var e=new d(this,b);c.data("pgm-geocoder",e)}})};var e=function(){google.maps.visualRefresh=pronamic_google_maps_settings.visualRefresh,a("#pronamic-google-maps-meta-box").pronamicGoogleMapsMetaBox(),a("#pgm-geocoder").pronamicGoogleMapsGeocoder(),a("#widgets-right .pronamic-google-maps-widget").pronamicGoogleMapsWidget(),jQuery('div[id$="_pronamic_google_maps-__i__"]').bind("dragstop",function(){a("#widgets-right .pronamic-google-maps-widget").pronamicGoogleMapsWidget()})};a(document).ready(function(){google.load("maps","3",{callback:e,other_params:"sensor=false"})})}(jQuery);